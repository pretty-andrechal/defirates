<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi Rates - Yield Comparison</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>DeFi Rates</h1>
            <p class="subtitle">Compare yield rates across DeFi protocols</p>
        </header>

        <div class="filters-container">
            <form hx-get="/" hx-target="#rates-table" hx-trigger="change, submit" hx-push-url="true">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="asset">Asset</label>
                        <select name="asset" id="asset">
                            <option value="">All Assets</option>
                            {{range .Assets}}
                            <option value="{{.}}" {{if eq $.Filters.Asset .}}selected{{end}}>{{.}}</option>
                            {{end}}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="chain">Chain</label>
                        <select name="chain" id="chain">
                            <option value="">All Chains</option>
                            {{range .Chains}}
                            <option value="{{.}}" {{if eq $.Filters.Chain .}}selected{{end}}>{{.}}</option>
                            {{end}}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="categories">Categories</label>
                        <select name="categories" id="categories">
                            <option value="">All Categories</option>
                            {{range .Categories}}
                            <option value="{{.}}" {{if eq $.Filters.Categories .}}selected{{end}}>{{.}}</option>
                            {{end}}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="min_apy">Min APY (%)</label>
                        <input type="number" name="min_apy" id="min_apy" step="0.1"
                               placeholder="e.g., 5.0" value="{{if ne .Filters.MinAPY 0.0}}{{printf "%.2f" .Filters.MinAPY}}{{end}}">
                    </div>

                    <div class="filter-group">
                        <label for="max_apy">Max APY (%)</label>
                        <input type="number" name="max_apy" id="max_apy" step="0.1"
                               placeholder="e.g., 50.0" value="{{if ne .Filters.MaxAPY 0.0}}{{printf "%.2f" .Filters.MaxAPY}}{{end}}">
                    </div>

                    <div class="filter-group">
                        <label for="min_tvl">Min TVL ($)</label>
                        <input type="number" name="min_tvl" id="min_tvl" step="1000"
                               placeholder="e.g., 100000" value="{{if ne .Filters.MinTVL 0.0}}{{printf "%.0f" .Filters.MinTVL}}{{end}}">
                    </div>

                    <div class="filter-group">
                        <label for="sort_by">Sort By</label>
                        <select name="sort_by" id="sort_by">
                            <option value="apy" {{if eq .Filters.SortBy "apy"}}selected{{end}}>APY</option>
                            <option value="tvl" {{if eq .Filters.SortBy "tvl"}}selected{{end}}>TVL</option>
                            <option value="updated_at" {{if eq .Filters.SortBy "updated_at"}}selected{{end}}>Last Updated</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="sort_order">Order</label>
                        <select name="sort_order" id="sort_order">
                            <option value="desc" {{if eq .Filters.SortOrder "desc"}}selected{{end}}>Descending</option>
                            <option value="asc" {{if eq .Filters.SortOrder "asc"}}selected{{end}}>Ascending</option>
                        </select>
                    </div>

                    <div class="filter-group filter-buttons">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        <a href="/" class="btn btn-secondary">Clear</a>
                    </div>
                </div>
            </form>
        </div>

        <div id="rates-table">
            {{template "table.html" .}}
        </div>

        <footer>
            <p>Data refreshed periodically from DeFi protocols. Currently showing: Pendle, Beefy Finance</p>
            <p>Built with Go and HTMX | <span id="connection-status" class="status-disconnected">Connecting to live updates...</span></p>
            <details style="margin-top: 1rem;">
                <summary style="cursor: pointer; font-weight: bold;">Debug Log (Click to expand)</summary>
                <div id="debug-log" style="background: #f5f5f5; padding: 1rem; border-radius: 4px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.875rem; margin-top: 0.5rem;"></div>
            </details>
        </footer>
    </div>

    <script>
        // Debug logging function
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = timestamp + ': ' + message;
            console.log(logMessage);

            const debugDiv = document.getElementById('debug-log');
            if (debugDiv) {
                const entry = document.createElement('div');
                entry.textContent = logMessage;
                debugDiv.appendChild(entry);
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }
    </script>
    <script>
        // Real-time updates using Server-Sent Events
        (function() {
            let eventSource = null;
            let reconnectDelay = 1000;
            const maxReconnectDelay = 30000;

            function connectSSE() {
                // Update status
                const statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    statusEl.textContent = 'Connecting to live updates...';
                    statusEl.className = 'status-connecting';
                }

                // Connect to SSE endpoint
                eventSource = new EventSource('/events');

                eventSource.addEventListener('connected', function(e) {
                    debugLog('SSE: Connected to real-time updates');
                    if (statusEl) {
                        statusEl.textContent = 'Live updates active';
                        statusEl.className = 'status-connected';
                    }
                    reconnectDelay = 1000; // Reset reconnect delay on successful connection
                });

                eventSource.addEventListener('update', function(e) {
                    debugLog('SSE: Data update received - ' + e.data);
                    updateVisibleRates();
                });

                eventSource.onerror = function(e) {
                    debugLog('SSE: Connection error or disconnected');
                    eventSource.close();

                    if (statusEl) {
                        statusEl.textContent = 'Reconnecting...';
                        statusEl.className = 'status-disconnected';
                    }

                    // Reconnect with exponential backoff
                    setTimeout(connectSSE, reconnectDelay);
                    reconnectDelay = Math.min(reconnectDelay * 2, maxReconnectDelay);
                };
            }

            function getVisibleRateIds() {
                const tbody = document.getElementById('rates-tbody');
                if (!tbody) {
                    debugLog('WARNING: rates-tbody not found in DOM');
                    return [];
                }

                const rows = tbody.querySelectorAll('tr[data-rate-id]');
                debugLog('Found ' + rows.length + ' rows with data-rate-id');

                const ids = [];
                rows.forEach(row => {
                    const id = row.getAttribute('data-rate-id');
                    if (id) ids.push(id);
                });
                debugLog('Extracted IDs: ' + ids.join(', '));
                return ids;
            }

            function updateVisibleRates() {
                debugLog('updateVisibleRates() called');

                const ids = getVisibleRateIds();
                if (ids.length === 0) {
                    debugLog('No visible rates to update');
                    return;
                }

                debugLog('Updating ' + ids.length + ' visible rates');

                // Fetch updated data for visible IDs
                const url = '/api/rates?ids=' + ids.join(',');
                debugLog('Fetching: ' + url);

                fetch(url)
                    .then(response => {
                        debugLog('Fetch response status: ' + response.status);
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status);
                        }
                        return response.text();
                    })
                    .then(html => {
                        debugLog('Received HTML, length: ' + html.length);

                        // Parse the HTML to get individual rows
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newRows = doc.querySelectorAll('tr[data-rate-id]');

                        debugLog('Parsed ' + newRows.length + ' new rows from response');

                        // Update each row in place (maintaining order)
                        let updatedCount = 0;
                        newRows.forEach(newRow => {
                            const id = newRow.getAttribute('data-rate-id');
                            const existingRow = document.getElementById('rate-' + id);

                            if (existingRow) {
                                // Replace the existing row's content with new content
                                existingRow.innerHTML = newRow.innerHTML;

                                // Add a brief highlight animation
                                existingRow.classList.add('row-updated');
                                setTimeout(() => {
                                    existingRow.classList.remove('row-updated');
                                }, 1000);

                                updatedCount++;
                            }
                        });

                        debugLog('Successfully updated ' + updatedCount + ' rows in place');
                    })
                    .catch(error => {
                        debugLog('ERROR: Failed to fetch rate updates - ' + error.message);
                    });
            }

            // Initialize SSE connection
            connectSSE();

            // Clean up on page unload
            window.addEventListener('beforeunload', function() {
                if (eventSource) {
                    eventSource.close();
                }
            });
        })();
    </script>
</body>
</html>
