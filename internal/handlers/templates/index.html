<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi Rates - Yield Comparison</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>DeFi Rates</h1>
            <p class="subtitle">Compare yield rates across DeFi protocols</p>
        </header>

        <div class="filters-container">
            <form hx-get="/" hx-target="#rates-table" hx-trigger="change, submit" hx-push-url="true">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="asset">Asset</label>
                        <select name="asset" id="asset">
                            <option value="">All Assets</option>
                            {{range .Assets}}
                            <option value="{{.}}" {{if eq $.Filters.Asset .}}selected{{end}}>{{.}}</option>
                            {{end}}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="chain">Chain</label>
                        <select name="chain" id="chain">
                            <option value="">All Chains</option>
                            {{range .Chains}}
                            <option value="{{.}}" {{if eq $.Filters.Chain .}}selected{{end}}>{{.}}</option>
                            {{end}}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="min_apy">Min APY (%)</label>
                        <input type="number" name="min_apy" id="min_apy" step="0.1"
                               placeholder="e.g., 5.0" value="{{if ne .Filters.MinAPY 0.0}}{{printf "%.2f" .Filters.MinAPY}}{{end}}">
                    </div>

                    <div class="filter-group">
                        <label for="max_apy">Max APY (%)</label>
                        <input type="number" name="max_apy" id="max_apy" step="0.1"
                               placeholder="e.g., 50.0" value="{{if ne .Filters.MaxAPY 0.0}}{{printf "%.2f" .Filters.MaxAPY}}{{end}}">
                    </div>

                    <div class="filter-group">
                        <label for="min_tvl">Min TVL ($)</label>
                        <input type="number" name="min_tvl" id="min_tvl" step="1000"
                               placeholder="e.g., 100000" value="{{if ne .Filters.MinTVL 0.0}}{{printf "%.0f" .Filters.MinTVL}}{{end}}">
                    </div>

                    <div class="filter-group">
                        <label for="sort_by">Sort By</label>
                        <select name="sort_by" id="sort_by">
                            <option value="apy" {{if eq .Filters.SortBy "apy"}}selected{{end}}>APY</option>
                            <option value="tvl" {{if eq .Filters.SortBy "tvl"}}selected{{end}}>TVL</option>
                            <option value="updated_at" {{if eq .Filters.SortBy "updated_at"}}selected{{end}}>Last Updated</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="sort_order">Order</label>
                        <select name="sort_order" id="sort_order">
                            <option value="desc" {{if eq .Filters.SortOrder "desc"}}selected{{end}}>Descending</option>
                            <option value="asc" {{if eq .Filters.SortOrder "asc"}}selected{{end}}>Ascending</option>
                        </select>
                    </div>

                    <div class="filter-group filter-buttons">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        <a href="/" class="btn btn-secondary">Clear</a>
                    </div>
                </div>
            </form>
        </div>

        <div id="rates-table">
            {{template "table.html" .}}
        </div>

        <footer>
            <p>Data refreshed periodically from DeFi protocols. Currently showing: Pendle</p>
            <p>Built with Go and HTMX | <span id="connection-status" class="status-disconnected">Connecting to live updates...</span></p>
        </footer>
    </div>

    <script>
        // Real-time updates using Server-Sent Events
        (function() {
            let eventSource = null;
            let reconnectDelay = 1000;
            const maxReconnectDelay = 30000;

            function connectSSE() {
                // Update status
                const statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    statusEl.textContent = 'Connecting to live updates...';
                    statusEl.className = 'status-connecting';
                }

                // Connect to SSE endpoint
                eventSource = new EventSource('/events');

                eventSource.addEventListener('connected', function(e) {
                    console.log('SSE: Connected to real-time updates');
                    if (statusEl) {
                        statusEl.textContent = 'Live updates active';
                        statusEl.className = 'status-connected';
                    }
                    reconnectDelay = 1000; // Reset reconnect delay on successful connection
                });

                eventSource.addEventListener('update', function(e) {
                    console.log('SSE: Data update received', e.data);
                    updateVisibleRates();
                });

                eventSource.onerror = function(e) {
                    console.error('SSE: Connection error', e);
                    eventSource.close();

                    if (statusEl) {
                        statusEl.textContent = 'Reconnecting...';
                        statusEl.className = 'status-disconnected';
                    }

                    // Reconnect with exponential backoff
                    setTimeout(connectSSE, reconnectDelay);
                    reconnectDelay = Math.min(reconnectDelay * 2, maxReconnectDelay);
                };
            }

            function getVisibleRateIds() {
                const tbody = document.getElementById('rates-tbody');
                if (!tbody) return [];

                const rows = tbody.querySelectorAll('tr[data-rate-id]');
                const ids = [];
                rows.forEach(row => {
                    const id = row.getAttribute('data-rate-id');
                    if (id) ids.push(id);
                });
                return ids;
            }

            function updateVisibleRates() {
                const ids = getVisibleRateIds();
                if (ids.length === 0) {
                    console.log('No visible rates to update');
                    return;
                }

                console.log('Updating', ids.length, 'visible rates');

                // Fetch updated data for visible IDs
                fetch('/api/rates?ids=' + ids.join(','))
                    .then(response => response.text())
                    .then(html => {
                        // Parse the HTML to get individual rows
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newRows = doc.querySelectorAll('tr[data-rate-id]');

                        // Update each row in place (maintaining order)
                        newRows.forEach(newRow => {
                            const id = newRow.getAttribute('data-rate-id');
                            const existingRow = document.getElementById('rate-' + id);
                            if (existingRow) {
                                // Replace the existing row's content with new content
                                existingRow.innerHTML = newRow.innerHTML;

                                // Add a brief highlight animation
                                existingRow.classList.add('row-updated');
                                setTimeout(() => {
                                    existingRow.classList.remove('row-updated');
                                }, 1000);
                            }
                        });

                        console.log('Updated', newRows.length, 'rows in place');
                    })
                    .catch(error => {
                        console.error('Failed to fetch rate updates:', error);
                    });
            }

            // Initialize SSE connection
            connectSSE();

            // Clean up on page unload
            window.addEventListener('beforeunload', function() {
                if (eventSource) {
                    eventSource.close();
                }
            });
        })();
    </script>
</body>
</html>
